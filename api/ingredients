// A simple in-memory array to store ingredients.
// **WARNING**: Data will be lost when the serverless function instance is recycled.
const ingredients = [
    { id: 1, name: "Milk", amount: "1 Gallon", expiryDate: "2025-12-15" },
    { id: 2, name: "Eggs", amount: "1 Dozen", expiryDate: "2026-01-01" }
];

// Helper to assign unique IDs
let nextId = ingredients.length > 0 ? ingredients[ingredients.length - 1].id + 1 : 1;

/**
 * Main handler function for the /api/ingredients endpoint.
 * @param {import('@vercel/node').VercelRequest} req 
 * @param {import('@vercel/node').VercelResponse} res 
 */
module.exports = (req, res) => {
    // Enable CORS for simple front-end testing
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // Handle preflight OPTIONS request
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    switch (req.method) {
        case 'GET':
            // ✅ GET: Return all ingredients
            res.status(200).json({
                success: true,
                count: ingredients.length,
                data: ingredients
            });
            break;

        case 'POST':
            // ✅ POST: Add a new ingredient
            try {
                const { name, amount, expiryDate } = req.body;

                // Error handling for missing fields
                if (!name || !amount || !expiryDate) {
                    res.status(400).json({
                        success: false,
                        error: 'Missing required fields: name, amount, and expiryDate are required.'
                    });
                    return;
                }

                const newIngredient = {
                    id: nextId++,
                    name,
                    amount,
                    expiryDate
                };

                ingredients.push(newIngredient);

                res.status(201).json({
                    success: true,
                    data: newIngredient
                });

            } catch (error) {
                console.error("POST Error:", error);
                res.status(500).json({
                    success: false,
                    error: 'Server error when processing POST request.'
                });
            }
            break;

        default:
            // ❌ Handle unsupported methods
            res.setHeader('Allow', ['GET', 'POST']);
            res.status(405).end(`Method ${req.method} Not Allowed`);
            break;
    }
};
