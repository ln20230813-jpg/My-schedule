<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredient Expiry Tracker Client</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { display: flex; gap: 20px; }
        #addForm { border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 1; }
        #results { border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 2; }
        input[type="text"], input[type="date"], button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { opacity: 0.9; }
        h3 { margin-top: 0; }
        pre { background-color: #eee; padding: 10px; overflow-x: auto; }
        .ingredient-item { border-bottom: 1px dashed #ddd; padding: 10px 0; }
        .ingredient-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <h1>üç≤ Ingredient Expiry Tracker</h1>

    <p>This page uses **Fetch API** to interact with the Vercel serverless function at `/api/ingredients`.</p>
    <div class="container">
        
        <div id="addForm">
            <h3>Add New Ingredient (POST)</h3>
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="e.g., Flour" required>

            <label for="amount">Amount:</label>
            <input type="text" id="amount" placeholder="e.g., 500g" required>

            <label for="expiryDate">Expiry Date:</label>
            <input type="date" id="expiryDate" required>

            <button onclick="postIngredient()">Add Ingredient</button>
            <p id="postStatus"></p>
        </div>

        <div id="results">
            <h3>Current Ingredients (GET)</h3>
            <button onclick="getIngredients()">Refresh List</button>
            <div id="ingredientList">
                <p>Click "Refresh List" to load ingredients.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Use the relative path when deployed on Vercel
        const API_URL = '/api/ingredients'; 

        // --- GET Ingredients ---
        async function getIngredients() {
            const listDiv = document.getElementById('ingredientList');
            listDiv.innerHTML = 'Loading...';
            
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.success) {
                    renderIngredients(data.data);
                } else {
                    listDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">Failed to fetch ingredients. Check your network or Vercel deployment.</p>`;
                console.error('Fetch error:', error);
            }
        }

        function renderIngredients(ingredients) {
            const listDiv = document.getElementById('ingredientList');
            if (ingredients.length === 0) {
                listDiv.innerHTML = '<p>No ingredients found. Add one!</p>';
                return;
            }

            listDiv.innerHTML = ingredients.map(item => `
                <div class="ingredient-item">
                    <strong>${item.name}</strong> (${item.amount})<br>
                    Expires: <span style="color: ${isExpired(item.expiryDate) ? 'red' : 'green'};">
                        ${item.expiryDate} ${isExpired(item.expiryDate) ? '(EXPIRED)' : ''}
                    </span>
                </div>
            `).join('');
        }

        function isExpired(dateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to midnight
            const expiry = new Date(dateString);
            return expiry < today;
        }

        // --- POST Ingredient ---
        async function postIngredient() {
            const name = document.getElementById('name').value;
            const amount = document.getElementById('amount').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const statusP = document.getElementById('postStatus');

            statusP.style.color = 'black';
            statusP.textContent = 'Submitting...';

            const payload = { name, amount, expiryDate };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.status === 201 && data.success) {
                    statusP.style.color = 'green';
                    statusP.textContent = `Success! Added: ${data.data.name}`;
                    // Refresh the list after successful post
                    getIngredients(); 
                } else if (response.status === 400 && !data.success) {
                    statusP.style.color = 'red';
                    statusP.textContent = `Error: ${data.error}`;
                } else {
                    statusP.style.color = 'red';
                    statusP.textContent = `An unknown error occurred. Status: ${response.status}`;
                }
            } catch (error) {
                statusP.style.color = 'red';
                statusP.textContent = `Post failed. Check console.`;
                console.error('Post error:', error);
            }
        }
    </script>
</body>
</html>
